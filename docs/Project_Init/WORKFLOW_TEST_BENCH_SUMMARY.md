# Workflow Test Bench (Testing for Agent Git v0.2) - Executive Summary

## 1. Overview

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                    用户层                                            │
│  ┌─────────────┐   ┌─────────────┐   ┌─────────────┐   ┌─────────────┐              │
│  │   Web UI    │   │     CLI     │   │  REST API   │   │  WebSocket  │              │
│  └──────┬──────┘   └──────┬──────┘   └──────┬──────┘   └──────┬──────┘              │
└─────────┼─────────────────┼─────────────────┼─────────────────┼──────────────────────┘
          │                 │                 │                 │
          └─────────────────┴────────┬────────┴─────────────────┘
                                     │
┌────────────────────────────────────▼────────────────────────────────────────────────┐
│                                                                                      │
│                          Workflow Test Bench (WTB)                                   │
│                              ══════════════════                                      │
│                                  核心编排层                                           │
│  ┌────────────────────────────────────────────────────────────────────────────────┐ │
│  │                           TestOrchestrator                                      │ │
│  │  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐           │ │
│  │  │ Execution    │ │    Node      │ │    Batch     │ │  Evaluation  │           │ │
│  │  │ Controller   │ │   Replacer   │ │  TestRunner  │ │    Engine    │           │ │
│  │  │              │ │              │ │              │ │              │           │ │
│  │  │ •run/pause   │ │ •hot-swap    │ │ •parallel    │ │ •metrics     │           │ │
│  │  │ •resume/stop │ │ •variants    │ │ •compare     │ │ •scoring     │           │ │
│  │  └──────┬───────┘ └──────┬───────┘ └──────┬───────┘ └──────┬───────┘           │ │
│  └─────────┼────────────────┼────────────────┼────────────────┼────────────────────┘ │
│            │                │                │                │                      │
│            └────────────────┴────────┬───────┴────────────────┘                      │
│                                      │                                               │
│  ┌───────────────────────────────────▼───────────────────────────────────────────┐  │
│  │                        State Adapter Registry                                  │  │
│  │                     (依赖注入 - 可插拔适配器)                                   │  │
│  └───────────────────────────────────┬───────────────────────────────────────────┘  │
│                                      │                                               │
│         ┌────────────────────────────┼────────────────────────────┐                 │
│         │                            │                            │                 │
│         ▼                            ▼                            ▼                 │
│  ┌────────────┐            ┌──────────────────┐           ┌────────────────┐        │
│  │  InMemory  │            │   AgentGit       │           │  FileTracker   │        │
│  │  Adapter   │            │   Adapter        │           │  Adapter       │        │
│  │            │            │                  │           │                │        │
│  │ 开发/测试   │            │ 状态+分支+回滚    │           │ 文件版本控制    │        │
│  └────────────┘            └────────┬─────────┘           └───────┬────────┘        │
│                                     │                             │                 │
└─────────────────────────────────────┼─────────────────────────────┼─────────────────┘
                                      │                             │
              ┌───────────────────────┴─────────────────────────────┴───────────────┐
              │                                                                     │
              ▼                                                                     ▼
┌──────────────────────────────────┐                       ┌──────────────────────────────┐
│                                  │                       │                              │
│      AgentGit v0.2.0 
        (change agent infra)       │                       │      FileTracker             │
│      ══════════════              │                       │      ══════════              │
│                                  │                       │                              │
│  ┌────────────────────────────┐  │                       │  ┌────────────────────────┐  │
│  │ CheckpointManager_mdp      │  │                       │  │ BlobRepository         │  │
│  │ • Node Checkpoint          │  │                       │  │ • 内容寻址存储          │  │
│  │ • Tool/Message Checkpoint  │  │                       │  │ • SHA-256 去重         │  │
│  └────────────────────────────┘  │                       │  └────────────────────────┘  │
│  ┌────────────────────────────┐  │                       │  ┌────────────────────────┐  │
│  │ InternalSession_mdp        │  │                       │  │ CommitRepository       │  │
│  │ • workflow_variables       │  │                       │  │ • 版本历史             │  │
│  │ • execution_path           │  │                       │  │ • 时间线               │  │
│  └────────────────────────────┘  │                       │  └────────────────────────┘  │
│  ┌────────────────────────────┐  │                       │  ┌────────────────────────┐  │
│  │ ToolManager                │  │                       │  │ FileMementoRepository  │  │
│  │ • 工具调用追踪              │  │                       │  │ • 文件快照             │  │
│  │ • 副作用回滚               │  │                       │  │ • 路径映射             │  │
│  └────────────────────────────┘  │                       │  └────────────────────────┘  │
│                                  │                       │                              │
│  DB: checkpoints,            │                       │  PostgreSQL + 文件系统:       │
│          internal_sessions       │                       │  file_blobs, commits,        │
│                                  │                       │  file_mementos, objects/     │
└──────────────────────────────────┘                       └──────────────────────────────┘
              │
              │ 可选同步
              ▼
┌──────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                      │
│                         agent-git-testing-ide                                        │
│                         ═════════════════════                                        │
│                              UI & 审计层                                              │
│                                                                                      │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │   Dashboard     │  │  Session Detail │  │   Audit Trail   │  │  Branch Tree    │ │
│  │   (Web UI)      │  │   (Web UI)      │  │   (API)         │  │  (Visualization)│ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
│                                                                                      │
│  PostgreSQL: audit_sessions, audit_events                                            │
│                                                                                      │
└──────────────────────────────────────────────────────────────────────────────────────┘
```




Error 集成 （目前有agent git error, 需要 1.标准化所有error 2. 需要一个抽象的error管理）

---

## 1.5 AgentGit + FileTracker 协调机制

### 设计原则

> **"基于最小粒度设计，分离关注点，在更高层次组合。"**

> **"WTB uses dual database patterns: AgentGit repositories for checkpoint state; SQLAlchemy UoW for WTB domain data."**

> **"Single Checkpoint Type + Node Boundary Pointers: All checkpoints atomic at tool/message level."**

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         统一检查点设计                                            │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  核心概念分离:                                                                    │
│  ═══════════                                                                     │
│                                                                                  │
│  1. Checkpoint (检查点)                                                          │
│     • 原子状态快照                                                               │
│     • 始终在 tool/message 级别 (最细粒度)                                         │
│     • 包含: checkpoint_data, tool_track_position, node_id                        │
│                                                                                  │
│  2. Node Boundary (节点边界)                                                      │
│     • 指向检查点的标记 (不是独立的检查点!)                                         │
│     • entry_checkpoint_id → 进入节点时的第一个检查点                              │
│     • exit_checkpoint_id  → 完成节点时的最后一个检查点                            │
│     • 回滚到"节点" = 回滚到 exit_checkpoint_id                                   │
│                                                                                  │
│  3. File Commit (文件提交)                                                        │
│     • 链接到 Checkpoint (不是 Node!)                                             │
│     • checkpoint_file_commits 表: checkpoint_id → file_commit_id                 │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│                         节点执行与检查点关系                                       │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  Node: "train"                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                                                                         │    │
│  │  Tool 1        Tool 2        Tool 3        Tool 4                      │    │
│  │  load_data     preprocess    train_model   save_model                  │    │
│  │     │              │              │              │                      │    │
│  │     ▼              ▼              ▼              ▼                      │    │
│  │  ┌──────┐      ┌──────┐      ┌──────┐      ┌──────┐                    │    │
│  │  │ CP#5 │      │ CP#6 │      │ CP#7 │      │ CP#8 │                    │    │
│  │  └──────┘      └──────┘      └──────┘      └──────┘                    │    │
│  │     │              │              │              │                      │    │
│  │     ▼              ▼              ▼              ▼                      │    │
│  │  ┌──────┐      ┌──────┐      ┌──────┐      ┌──────┐                    │    │
│  │  │File  │      │File  │      │File  │      │File  │                    │    │
│  │  │Commit│      │Commit│      │Commit│      │Commit│                    │    │
│  │  │ #A   │      │ #B   │      │ #C   │      │ #D   │                    │    │
│  │  └──────┘      └──────┘      └──────┘      └──────┘                    │    │
│  │                                                                         │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│       ▲                                                   ▲                     │
│       │                                                   │                     │
│       │              Node Boundary (train)                │                     │
│       │              ══════════════════════               │                     │
│       └───── entry_checkpoint_id = 5                      │                     │
│              exit_checkpoint_id = 8 ──────────────────────┘                     │
│                                                                                  │
│  回滚到节点 "train" = 回滚到 CP#8 = 恢复 File Commit #D                           │
│  回滚到工具 "preprocess" = 回滚到 CP#6 = 恢复 File Commit #B                      │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 统一回滚逻辑

```python
def rollback(target_checkpoint_id: int):
    """
    统一回滚逻辑 - 无论是节点级还是工具级，都是回滚到检查点。
    
    "节点级回滚" = 调用者传入 node_boundary.exit_checkpoint_id
    "工具级回滚" = 调用者传入任意 checkpoint.id
    
    回滚逻辑完全相同。
    """
    # 1. 从 AgentGit 加载检查点状态
    checkpoint = checkpoint_repo.get_by_id(target_checkpoint_id)
    session.restore_from_checkpoint(checkpoint)
    
    # 2. 回滚工具副作用 (此检查点之后的)
    tools_to_reverse = tool_invocation_repo.get_after_position(
        session.id, checkpoint.tool_track_position
    )
    for tool in reversed(tools_to_reverse):
        if tool.is_reversible:
            execute_reverse(tool)
    
    # 3. 恢复文件状态 (通过 FileTracker)
    file_link = checkpoint_file_commits_repo.get(checkpoint.id)
    if file_link:
        file_tracker.restore_commit(file_link.file_commit_id)
    
    return checkpoint
```

### 数据库外键关系

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              数据库 FK 关系                                       │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  AgentGit Database (SQLite)                                                     │
│  ════════════════════════════                                                   │
│                                                                                  │
│  users (1) ──────────────────────┬──► external_sessions (N)                     │
│                                  │                                               │
│  external_sessions (1) ──────────┼──► internal_sessions (N)                     │
│                                  │                                               │
│  internal_sessions (1) ──────────┼──► checkpoints (N)                           │
│                                  │                                               │
│                                  ├──► node_boundaries (N)                       │
│                                  │       ├── entry_checkpoint_id FK → checkpoints│
│                                  │       └── exit_checkpoint_id FK → checkpoints │
│                                  │                                               │
│                                  └──► tool_invocations (N)                       │
│                                          └── checkpoint_id FK → checkpoints      │
│                                                                                  │
│  checkpoints (1) ────────────────────► checkpoint_file_commits (0..1)           │
│                                            │                                     │
│                                            │ file_commit_id                      │
│                                            ▼                                     │
│  ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─  │
│                                                                                  │
│  FileTracker Database (PostgreSQL)                                              │
│  ═════════════════════════════════                                              │
│                                                                                  │
│  commits (commit_id PK) ─────────────► file_mementos (N)                        │
│                                            │                                     │
│                                            │ file_hash FK                        │
│                                            ▼                                     │
│  file_blobs (content_hash PK) ◄──────── file_mementos.file_hash                 │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## LLM Infra

1. Traj path data -> llm
2. workflow (node n) -> frezze , train node_llm
3. system -> restful api -> llm tool calling

## 2. 三系统协作关系

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           系统职责分工                                           │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│   WTB (Workflow Test Bench)           "大脑" - 决策与编排                        │
│   ┌─────────────────────────────────────────────────────────────────────────┐  │
│   │  • 工作流定义与解析                                                       │  │
│   │  • 执行控制 (何时运行、何时暂停)                                           │  │
│   │  • 节点替换与变体管理                                                     │  │
│   │  • 批量测试调度                                                          │  │
│   │  • 评估与打分                                                            │  │
│   └─────────────────────────────────────────────────────────────────────────┘  │
│                                      │                                          │
│                                      │ 委托                                     │
│                    ┌─────────────────┴─────────────────┐                       │
│                    ▼                                   ▼                       │
│   AgentGit v0.2.0                     FileTracker                              │
│   "记忆" - 状态与回滚                  "档案" - 文件版本                         │
│   ┌───────────────────────────┐      ┌───────────────────────────┐            │
│   │  • 保存执行状态快照        │      │  • 保存文件内容            │            │
│   │  • 管理分支树              │      │  • 追踪文件变更            │            │
│   │  • 回滚工具副作用          │      │  • 恢复历史版本            │            │
│   │  • 追踪工具调用历史        │      │  • 去重存储                │            │
│   └───────────────────────────┘      └───────────────────────────┘            │
│                                                                                 │
│                    ┌─────────────────┴─────────────────┐                       │
│                    ▼                                                           │
│   agent-git-testing-ide                                                        │
│   "窗口" - 可视化与审计                                                         │
│   ┌─────────────────────────────────────────────────────────────────────────┐  │
│   │  • 提供 Web 界面展示测试状态                                              │  │
│   │  • 记录所有操作的审计日志                                                 │  │
│   │  • 可视化分支树和执行路径                                                 │  │
│   │  • 提供实时监控 (WebSocket)                                              │  │
│   └─────────────────────────────────────────────────────────────────────────┘  │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. 数据流图

### 3.1 核心数据流

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              数据流向                                            │
└─────────────────────────────────────────────────────────────────────────────────┘

用户输入                    WTB 处理                     外部存储
─────────                  ─────────                    ─────────

  Workflow               ┌─────────────┐
  Definition  ──────────►│   解析并    │
  (YAML/JSON)            │   创建      │──────┐
                         │  TestWorkflow│      │
                         └─────────────┘      │
                                              │
                                              ▼
                         ┌─────────────┐   ┌──────────────────┐
  Execute    ──────────► │  Execution  │──►│ AgentGit         │
  Command                │  Controller │   │ • save checkpoint│
                         └─────────────┘   │ • create session │
                               │           └──────────────────┘
                               │
                               ▼           ┌──────────────────┐
                         ┌─────────────┐   │ FileTracker      │
                         │    Node     │──►│ • save blob      │
                         │  Executor   │   │ • create memento │
                         └─────────────┘   └──────────────────┘
                               │
                               │
                               ▼           ┌──────────────────┐
                         ┌─────────────┐   │ IDE              │
                         │  Evaluation │──►│ • audit event    │
                         │   Engine    │   │ • metrics        │
                         └─────────────┘   └──────────────────┘
                               │
                               ▼
                         ┌─────────────┐
  Results    ◄───────────│   Report    │
  & Metrics              │  Generator  │
                         └─────────────┘
```

### 3.2 状态同步数据流 (协调检查点模式)

```
┌──────────────────────────────────────────────────────────────────────────────────┐
│                         状态数据在三系统间的流动                                   │
│                    (基于最小粒度设计 - 每个工具调用创建检查点)                       │
└──────────────────────────────────────────────────────────────────────────────────┘

                    ① 执行前: 初始化
                    ━━━━━━━━━━━━━━━━━

WTB                          AgentGit                      IDE
 │                              │                           │
 │ ─── create session ────────► │                           │
 │                              │ ─── create internal ────► │ (sync)
 │ ◄── session_id ───────────── │      session              │
 │                              │                           │


                    ② 执行中: 每个工具调用时
                    ━━━━━━━━━━━━━━━━━━━━━━━━

WTB                          AgentGit                      FileTracker           IDE
 │                              │                              │                   │
 │ ──── execute_tool() ───────► │                              │                   │
 │                              │                              │                   │
 │                              │ ─ create checkpoint ───────► │                   │
 │                              │   (工具级, tool_track_pos++)  │                   │
 │                              │                              │                   │
 │ ──── track_files(paths) ────────────────────────────────────►                   │
 │                              │                              │                   │
 │                              │ ◄── file_commit_id ──────────│                   │
 │                              │                              │                   │
 │                              │ ─ link checkpoint ───────────│                   │
 │                              │   to file_commit             │                   │
 │                              │   (checkpoint_file_commits)  │                   │
 │                              │                              │                   │
 │ ─ sync_event(TOOL_END) ─────────────────────────────────────────────────────────►│
 │                              │                              │                   │


                    ③ 节点完成时: 创建边界标记 (不是新检查点!)
                    ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

WTB                          AgentGit                      FileTracker           IDE
 │                              │                              │                   │
 │ ─ on_node_complete(node_id)─►│                              │                   │
 │                              │                              │                   │
 │                              │ ─ create node_boundary ────► │                   │
 │                              │   entry_cp_id = first_cp     │                   │
 │                              │   exit_cp_id = last_cp       │                   │
 │                              │   (指向已有检查点，不创建新的) │                   │
 │                              │                              │                   │
 │ ─ sync_event(NODE_COMPLETE) ────────────────────────────────────────────────────►│
 │                              │                              │                   │


                    ④ 回滚时: 统一逻辑
                    ━━━━━━━━━━━━━━━━━

WTB                          AgentGit                      FileTracker           IDE
 │                              │                              │                   │
 │ ─ rollback(checkpoint_id) ─► │                              │                   │
 │   (可以是任意检查点:          │                              │                   │
 │    节点级 = exit_cp_id       │                              │                   │
 │    工具级 = 任意 cp.id)       │                              │                   │
 │                              │                              │                   │
 │                              │ ─ load checkpoint ─────────► │                   │
 │                              │                              │                   │
 │                              │ ─ get tools after position ─►│                   │
 │                              │                              │                   │
 │                              │ ─ reverse tools (LIFO) ─────►│                   │
 │                              │                              │                   │
 │                              │ ─ get file_commit_id ────────│                   │
 │                              │   from checkpoint_file_      │                   │
 │                              │   commits table              │                   │
 │                              │                              │                   │
 │                              │                              │ ◄─ restore ─────  │
 │                              │ ───────────────────────────► │   files           │
 │                              │                              │                   │
 │ ◄─ restored_state ────────── │                              │                   │
 │                              │                              │                   │
 │ ─ sync_event(ROLLBACK) ─────────────────────────────────────────────────────────►│
 │                              │                              │                   │
```

### 3.3 检查点与文件提交的链接

```
┌──────────────────────────────────────────────────────────────────────────────────┐
│                         Checkpoint ↔ FileTracker 关联                            │
└──────────────────────────────────────────────────────────────────────────────────┘

  AgentGit                           链接表                          FileTracker
  ════════                           ══════                          ═══════════

  checkpoints                 checkpoint_file_commits               commits
  ┌────────────┐              ┌─────────────────────┐              ┌────────────┐
  │ id: 42     │              │ checkpoint_id: 42   │              │commit_id:  │
  │ data: {...}│◄─────────────│ file_commit_id: ────┼─────────────►│ "abc123"   │
  │ node_id:   │              │   "abc123"          │              │            │
  │  "train"   │              │ file_count: 3       │              │ mementos:  │
  │            │              │ total_size: 1.2MB   │              │ ├─ model.pkl
  └────────────┘              └─────────────────────┘              │ ├─ config.json
                                                                    │ └─ logs.txt
                                                                    └────────────┘
                                                                           │
                                                                           ▼
                                                                    file_blobs
                                                                    (去重存储)
```

---

## 4. 用户操作流程 (Dummy Flows)

### Flow 1: 用户上传并执行工作流

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│  Flow 1: 基本工作流执行                                                          │
│  用户目标: 上传工作流定义，执行并查看结果                                          │
└─────────────────────────────────────────────────────────────────────────────────┘

用户操作                          系统响应                        数据存储
━━━━━━━                          ━━━━━━━                        ━━━━━━━

 ① 上传工作流 YAML
    ┌──────────────────┐
    │ name: "ML Pipeline"│
    │ nodes:            │
    │   - data_load     │
    │   - preprocess    │────────────►  WTB 解析
    │   - train         │              创建 TestWorkflow
    │   - evaluate      │                    │
    └──────────────────┘                     │
                                             ▼
                                      ┌─────────────┐
                                      │ workflow_id │──────────► SQLite/PostgreSQL
                                      │ = "wf_001"  │            wtb_workflows 表
                                      └─────────────┘

 ② 点击 "执行"
    ┌──────────────────┐
    │ initial_state:   │
    │   data_path: ... │────────────►  WTB 启动执行
    │   params: {...}  │              ExecutionController
    └──────────────────┘                    │
                                            │
                                            ▼
                                    ┌───────────────┐
                          ┌─────────│ Node: data_load│
                          │         └───────┬───────┘
                          │                 │
                          ▼                 ▼
                    ┌──────────┐     AgentGit 创建
                    │ AgentGit │     checkpoint #1 ──────────► agentgit.db
                    │ Adapter  │                               checkpoints 表
                    └──────────┘
                          │
                          │ (重复每个节点)
                          ▼
                    ┌───────────────┐
                    │ Node: train   │
                    └───────┬───────┘
                            │
                            ▼ 产生模型文件
                    ┌──────────────┐
                    │ FileTracker  │
                    │ save model.pkl│─────────────────────────► objects/ab/cdef...
                    └──────────────┘                            file_blobs 表

 ③ 实时查看进度
    (Web UI)         ◄───────────────  IDE WebSocket
                                       推送事件 ────────────────► audit_events 表


 ④ 执行完成，查看结果
    ┌──────────────────┐
    │ Results:         │
    │ - accuracy: 0.95 │◄────────────  WTB Evaluation
    │ - latency: 2.3s  │              Engine 聚合 ─────────────► wtb_evaluation_results
    │ - cost: $0.05    │
    └──────────────────┘
```

### Flow 2: 批量测试节点变体

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│  Flow 2: 批量 A/B 测试                                                           │
│  用户目标: 比较3种不同的训练算法，找出最优方案                                      │
└─────────────────────────────────────────────────────────────────────────────────┘

用户操作                          系统响应                        数据存储
━━━━━━━                          ━━━━━━━                        ━━━━━━━

 ① 注册节点变体
    ┌───────────────────────┐
    │ train_node variants:  │
    │   - v1: RandomForest  │─────────►  WTB NodeReplacer
    │   - v2: XGBoost       │           注册到 VariantRegistry ───► wtb_node_variants 表
    │   - v3: NeuralNet     │
    └───────────────────────┘

 ② 配置批量测试
    ┌───────────────────────┐
    │ BatchTestConfig:      │
    │   workflow: "wf_001"  │─────────►  WTB 创建配置
    │   variants:           │
    │     - {train: v1}     │
    │     - {train: v2}     │
    │     - {train: v3}     │
    │   parallel: 3         │
    └───────────────────────┘

 ③ 启动批量测试
    "开始测试"  ───────────────────────►  WTB BatchTestRunner
                                              │
                    ┌─────────────────────────┼─────────────────────────┐
                    │                         │                         │
                    ▼                         ▼                         ▼
             ┌────────────┐           ┌────────────┐           ┌────────────┐
             │ Variant A  │           │ Variant B  │           │ Variant C  │
             │ (RF)       │           │ (XGB)      │           │ (NN)       │
             └─────┬──────┘           └─────┬──────┘           └─────┬──────┘
                   │                        │                        │
                   │     并行执行，各自独立分支                        │
                   │                        │                        │
                   ▼                        ▼                        ▼
             AgentGit                  AgentGit                  AgentGit
             Session A                Session B                Session C
             Checkpoint A1            Checkpoint B1            Checkpoint C1
                   │                        │                        │
                   └────────────────────────┼────────────────────────┘
                                            │
                                            ▼
 ④ 查看对比结果
    ┌─────────────────────────────────────────────────────────────────┐
    │  Comparison Matrix                                               │
    │  ┌──────────┬──────────┬──────────┬──────────┬──────────┐       │
    │  │ Variant  │ Accuracy │ Latency  │  Cost    │  Overall │       │
    │  ├──────────┼──────────┼──────────┼──────────┼──────────┤       │
    │  │ v1 (RF)  │  0.92    │  1.2s    │  $0.02   │  0.85    │       │
    │  │ v2 (XGB) │  0.95 ✓  │  2.1s    │  $0.03   │  0.88 ✓  │ ◄─Best│
    │  │ v3 (NN)  │  0.94    │  5.3s    │  $0.15   │  0.72    │       │
    │  └──────────┴──────────┴──────────┴──────────┴──────────┘       │
    │                                                                  │
    │  Recommendation: Use v2 (XGBoost) - best overall score          │
    └─────────────────────────────────────────────────────────────────┘
                                            │
                                            ▼
                                    ┌───────────────┐
                                    │ wtb_batch_tests│
                                    │ comparison_   │
                                    │ matrix (JSON) │
                                    └───────────────┘
```

### Flow 3: 暂停-检查-修改-恢复

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│  Flow 3: 调试工作流 (暂停与恢复)                                                  │
│  用户目标: 在特定节点暂停，检查状态，修改参数后继续                                 │
└─────────────────────────────────────────────────────────────────────────────────┘

用户操作                          系统响应                        数据存储
━━━━━━━                          ━━━━━━━                        ━━━━━━━

 ① 设置断点
    ┌───────────────────────┐
    │ breakpoints:          │
    │   - "preprocess"      │─────────►  WTB 记录断点
    │   - "train"           │           PauseStrategy
    └───────────────────────┘

 ② 启动执行
    "执行"  ──────────────────────────►  开始执行
                                              │
                                              ▼
                                        data_load ✓
                                              │
                                              ▼
                                        preprocess
                                         ⏸️ 暂停!
                                              │
                                              ▼
                                     ┌───────────────┐
                                     │ 创建 Snapshot │
                                     │ • 当前状态    │──────────► AgentGit
                                     │ • 中间数据    │──────────► FileTracker
                                     └───────────────┘

 ③ 检查当前状态
    ┌─────────────────────────────────────────┐
    │ Current State:                          │
    │ {                                       │
    │   "data": <DataFrame 1000 rows>,        │◄──────────  WTB 返回
    │   "preprocessing_params": {             │            当前状态
    │     "normalize": true,                  │
    │     "fill_na": "mean"                   │
    │   }                                     │
    │ }                                       │
    └─────────────────────────────────────────┘

 ④ 修改状态
    ┌───────────────────────┐
    │ modified_state:       │
    │   fill_na: "median"   │─────────►  WTB 更新
    │   add_feature: true   │           内存状态
    └───────────────────────┘

 ⑤ 恢复执行
    "继续"  ──────────────────────────►  WTB resume()
                                              │
                                              ▼
                                        preprocess ✓ (使用新参数)
                                              │
                                              ▼
                                        train
                                         ⏸️ 暂停!
                                              │
                                              ▼
                                      (用户可以继续调试...)

 ⑥ 回滚到之前状态
    "回滚到 preprocess 之前"  ─────────►  WTB rollback()
                                              │
                                              ├─────► AgentGit: 恢复状态
                                              │
                                              ├─────► FileTracker: 恢复文件
                                              │
                                              ▼
                                      回到 data_load ✓ 之后的状态
```

### Flow 4: 错误恢复与重试

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│  Flow 4: 错误处理与恢复                                                          │
│  用户目标: 节点执行失败后，修复问题并从失败点恢复                                   │
└─────────────────────────────────────────────────────────────────────────────────┘

执行过程                          系统响应                        用户操作
━━━━━━━                          ━━━━━━━                        ━━━━━━━

 data_load ✓
      │
      ▼
 preprocess ✓   ─────────────►  Checkpoint #2 保存
      │
      ▼
 train ❌ 失败!
 Error: "CUDA out of memory"
      │
      ▼
┌─────────────────────────────────────┐
│ WTB 捕获错误                         │
│ • 记录错误详情                       │──────────────► IDE audit_events
│ • 保存失败时的状态                   │              severity: "error"
│ • 不创建新 checkpoint               │
└─────────────────────────────────────┘
                                                    用户查看错误:
                                              ┌─────────────────────────┐
                                              │ Error in train node:    │
                                              │ CUDA out of memory      │
                                              │                         │
                                              │ Last checkpoint: #2     │
                                              │ (preprocess)            │
                                              └─────────────────────────┘
                                                           │
                                                           ▼
                                              ┌─────────────────────────┐
                                              │ 用户修改配置:            │
                                              │ batch_size: 32 → 16     │
                                              └─────────────────────────┘
                                                           │
                                                           ▼
                                              ┌─────────────────────────┐
                                              │ "从 Checkpoint #2 恢复"  │
                                              └─────────────────────────┘
                                                           │
      ┌────────────────────────────────────────────────────┘
      ▼
┌─────────────────────────────────────┐
│ WTB 恢复流程:                        │
│ 1. 从 AgentGit 加载 Checkpoint #2   │
│ 2. 恢复 workflow_variables          │
│ 3. 恢复 FileTracker 文件状态        │
│ 4. 应用用户修改 (batch_size)        │
│ 5. 从 train 节点重新开始            │
└─────────────────────────────────────┘
      │
      ▼
 train ✓ (使用新 batch_size)
      │
      ▼
 evaluate ✓
      │
      ▼
 完成! ✓
```

---

## 5. 数据存储分布

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              数据存储位置总览                                     │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│  WTB 存储抽象层 (Dual Implementation Pattern)                                    │
│  ───────────────────────────────────────────                                     │
│                                                                                  │
│  ┌────────────────────────────────────────────────────────────────────────────┐ │
│  │                         IUnitOfWork (接口)                                  │ │
│  │  ├── workflows: IWorkflowRepository                                        │ │
│  │  ├── executions: IExecutionRepository                                      │ │
│  │  ├── node_boundaries: INodeBoundaryRepository                              │ │
│  │  └── checkpoint_files: ICheckpointFileRepository                           │ │
│  └────────────────────────────────────────────────────────────────────────────┘ │
│                           │                     │                               │
│                           ▼                     ▼                               │
│  ┌─────────────────────────────┐   ┌─────────────────────────────┐             │
│  │     InMemoryUnitOfWork      │   │   SQLAlchemyUnitOfWork      │             │
│  │     ───────────────────     │   │   ────────────────────      │             │
│  │   • 单元测试                 │   │   • 生产环境                 │             │
│  │   • 快速迭代                 │   │   • SQLite/PostgreSQL       │             │
│  │   • 无 I/O 开销             │   │   • 数据持久化               │             │
│  └─────────────────────────────┘   └─────────────────────────────┘             │
│                                                                                  │
│  切换方式: UnitOfWorkFactory.create(mode="inmemory|sqlalchemy")                 │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│  WTB 专用存储 (SQLite/PostgreSQL - SQLAlchemyUnitOfWork 模式)                    │
│  ─────────────────────────────────────────────────────────                       │
│                                                                                  │
│  wtb_workflows          工作流定义                                                │
│  wtb_executions         执行记录与状态                                            │
│  wtb_node_boundaries    节点边界 (指向 AgentGit checkpoint 的指针)                │
│  wtb_checkpoint_files   检查点文件链接 (链接 AgentGit 与 FileTracker)             │
│  wtb_node_variants      节点变体配置                                              │
│  wtb_evaluation_results 评估结果                                                  │
│  wtb_batch_tests        批量测试记录                                              │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      │ 关联
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│  AgentGit 存储 (SQLite: agentgit.db)                                             │
│  ────────────────────────────────────                                            │
│                                                                                  │
│  external_sessions    外部会话 (用户级)                                           │
│  internal_sessions    内部会话 (分支级)                                           │
│  checkpoints          状态快照                                                   │
│  users                用户信息                                                   │
│                                                                                  │
│  元数据扩展 (checkpoints.metadata):                                               │
│  • wtb_execution_id   关联 WTB 执行                                              │
│  • file_artifacts     文件变更记录                                                │
│  • mdp_state          MDP 状态数据                                               │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      │ 关联
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│  FileTracker 存储 (PostgreSQL + 文件系统)                                         │
│  ─────────────────────────────────────────                                       │
│                                                                                  │
│  PostgreSQL:                                                                     │
│  commits              提交记录                                                   │
│  file_blobs           Blob 元数据 (hash -> location)                             │
│  file_mementos        文件快照记录                                                │
│                                                                                  │
│  文件系统 (objects/):                                                             │
│  objects/ab/cdef...   实际文件内容 (SHA-256 分片存储)                              │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      │ 关联 (可选)
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│  IDE 存储 (PostgreSQL)                                                           │
│  ──────────────────────                                                          │
│                                                                                  │
│  audit_sessions       审计会话                                                   │
│  audit_events         审计事件 (工具调用、错误、LLM调用等)                          │
│  test_runs            测试运行记录                                                │
│                                                                                  │
│  关联字段:                                                                        │
│  • audit_sessions.metadata.wtb_execution_id                                      │
│  • audit_events.details.wtb_node_id                                              │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 5.5 并行会话设计 (Parallel Internal Sessions)

### 设计目标

BatchTestRunner 需要**并行执行**多个 variant 组合，每个并行执行需要独立的上下文：

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        并行会话隔离架构                                           │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  BatchTestRunner                                                                │
│       │                                                                          │
│       ├── ParallelContextFactory.create_context(variant_a)                      │
│       │       └── Context A: Adapter A + Controller A + Session A               │
│       │                                                                          │
│       ├── ParallelContextFactory.create_context(variant_b)                      │
│       │       └── Context B: Adapter B + Controller B + Session B               │
│       │                                                                          │
│       └── ThreadPoolExecutor / asyncio.gather()                                 │
│               │                                                                  │
│       ┌───────┼───────────────────┐                                             │
│       │       │                   │                                             │
│       ▼       ▼                   ▼                                             │
│  ┌────────┐  ┌────────┐      ┌────────┐                                        │
│  │Context │  │Context │ ...  │Context │                                        │
│  │   A    │  │   B    │      │   N    │                                        │
│  │        │  │        │      │        │                                        │
│  │Session │  │Session │      │Session │    ← 每个 context 独立的 session        │
│  │  A     │  │  B     │      │  N     │                                        │
│  └────┬───┘  └────┬───┘      └────┬───┘                                        │
│       │           │               │                                             │
│       └───────────┴───────────────┘                                             │
│                   │                                                              │
│                   ▼                                                              │
│       ┌───────────────────────┐                                                 │
│       │   AgentGit Database   │                                                 │
│       │   (WAL Mode 启用)      │   ← SQLite WAL 模式支持并发写入                  │
│       │                       │                                                 │
│       │ internal_sessions:    │                                                 │
│       │ ├── Session A (id=1)  │                                                 │
│       │ ├── Session B (id=2)  │                                                 │
│       │ └── Session N (id=N)  │                                                 │
│       └───────────────────────┘                                                 │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 关键设计决策

| 问题 | 解决方案 |
|------|----------|
| StateAdapter 是有状态的 (`_current_session`) | 每个并行执行创建独立的 Adapter 实例 |
| SQLite 默认不支持并发写入 | 启用 WAL (Write-Ahead Logging) 模式 |
| 会话资源泄漏 | SessionLifecycleManager 定时清理超时会话 |
| 线程安全 | ThreadPoolExecutor + 完全隔离的 context |

### 核心组件

```
ParallelExecutionContext
├── ExecutionController instance (独立)
├── AgentGitStateAdapter instance (独立)
├── UnitOfWork instance (独立 DB session)
└── VariantCombination (配置)

ParallelContextFactory
└── create_context(variant) → ParallelExecutionContext

BatchTestRunner
├── run_batch_test(batch_test) → 协调并行执行
└── _run_single_variant(context) → 在独立 context 中运行
```

### 详细设计

参见: `docs/Project_Init/WORKFLOW_TEST_BENCH_ARCHITECTURE.md` Section 16

---

## 6. 快速参考

### API 端点对照

| 功能     | WTB 端点                               | AgentGit 接口                                  | IDE 端点                                      |
| -------- | -------------------------------------- | ---------------------------------------------- | --------------------------------------------- |
| 创建会话 | `POST /api/executions`               | `InternalSessionRepository.create()`         | `POST /api/operations/agents/create`        |
| 执行     | `POST /api/executions/{id}/run`      | `RollbackAgent_mdp.run()`                    | `POST /api/operations/agents/{id}/send`     |
| 暂停     | `POST /api/executions/{id}/pause`    | -                                              | -                                             |
| 恢复     | `POST /api/executions/{id}/resume`   | -                                              | `POST /api/plan/step/{id}/execute`          |
| 回滚     | `POST /api/executions/{id}/rollback` | `RollbackAgent_mdp.rollback_to_checkpoint()` | `POST /api/operations/agents/{id}/rollback` |
| 获取状态 | `GET /api/executions/{id}`           | `CheckpointManager_mdp.get_checkpoint()`     | `GET /api/audit/sessions/{id}`              |
| 批量测试 | `POST /api/batch-tests`              | `MDPBranchHelper.execute_branches()`         | -                                             |
| 评估     | `GET /api/executions/{id}/evaluate`  | -                                              | `GET /api/audit/sessions/{id}/summary`      |

### 配置模式

```yaml
# 最小配置 (单元测试 - 全内存)
mode: testing
state_adapter: inmemory           # InMemoryStateAdapter
wtb_storage: inmemory             # InMemoryUnitOfWork
# 无需数据库配置

# 开发配置 (持久化状态，内存 WTB)
mode: development
state_adapter: agentgit           # AgentGitStateAdapter
agentgit_db: ./data/agentgit.db
wtb_storage: inmemory             # InMemoryUnitOfWork (快速重启)

# 标准配置 (完整持久化)
mode: standalone
state_adapter: agentgit           # AgentGitStateAdapter
agentgit_db: ./data/agentgit.db
wtb_storage: sqlalchemy           # SQLAlchemyUnitOfWork
wtb_db: sqlite:///data/wtb.db

# 生产配置 (完整集成)
mode: full_integration
state_adapter: agentgit           # AgentGitStateAdapter
agentgit_db: ./data/agentgit.db
wtb_storage: sqlalchemy           # SQLAlchemyUnitOfWork
wtb_db: postgresql://user:pass@localhost/wtb
file_tracking: true
file_tracker_storage: ./storage
ide_sync: true
ide_url: http://localhost:8000
```

### 存储抽象组件

| 组件 | 接口 | 内存实现 | 数据库实现 |
|------|------|----------|------------|
| 状态适配器 | `IStateAdapter` | `InMemoryStateAdapter` | `AgentGitStateAdapter` |
| 工作单元 | `IUnitOfWork` | `InMemoryUnitOfWork` | `SQLAlchemyUnitOfWork` |
| 仓储 | `IRepository<T>` | `InMemory*Repository` | `*Repository` (SQLAlchemy) |

---

---

## 7. Data Characteristics & Storage Strategy (2025-01)

### 7.1 Data Lifecycle Classification

```
┌────────────────────────────────────────────────────────────────────────────────────┐
│                    WTB DATA LIFECYCLE TAXONOMY                                       │
├────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                    │
│  EPHEMERAL DATA (Request-scoped)                                                   │
│  ─────────────────────────────────                                                 │
│  │ Data Type          │ Lifetime        │ Storage         │ Access Pattern      │ │
│  ├────────────────────┼─────────────────┼─────────────────┼─────────────────────┤ │
│  │ Workflow Config    │ Single request  │ Ray ObjectRef   │ Read-once           │ │
│  │ Initial State      │ Single request  │ Ray ObjectRef   │ Read-once           │ │
│  │ Comparison Matrix  │ Response only   │ Memory/ObjectRef│ Computed, read-once │ │
│  │ Intermediate State │ Node execution  │ Stack/Heap      │ R/W within node     │ │
│                                                                                    │
│  SESSION DATA (Execution-scoped)                                                   │
│  ──────────────────────────────────                                                │
│  │ Data Type          │ Lifetime        │ Storage         │ Access Pattern      │ │
│  ├────────────────────┼─────────────────┼─────────────────┼─────────────────────┤ │
│  │ Execution State    │ Workflow run    │ Checkpoint JSON │ Snapshot/Restore    │ │
│  │ Node Boundaries    │ Workflow run    │ WTB DB          │ Append-only         │ │
│  │ Tool Invocations   │ Workflow run    │ AgentGit DB     │ Append-only         │ │
│  │ Audit Events       │ Session         │ WTB DB          │ Append-only         │ │
│                                                                                    │
│  PERSISTENT DATA (System-scoped)                                                   │
│  ────────────────────────────────                                                  │
│  │ Data Type          │ Lifetime        │ Storage         │ Access Pattern      │ │
│  ├────────────────────┼─────────────────┼─────────────────┼─────────────────────┤ │
│  │ Workflow Defs      │ Indefinite      │ PostgreSQL      │ Read-heavy, CRUD    │ │
│  │ Checkpoints        │ Configurable    │ AgentGit DB     │ Append, read for    │ │
│  │                    │ retention       │                 │ rollback            │ │
│  │ Batch Test Results │ Configurable    │ PostgreSQL      │ Append-only, query  │ │
│  │ File Blobs         │ Indefinite      │ FileTracker     │ Write-once, read    │ │
│                                                                                    │
└────────────────────────────────────────────────────────────────────────────────────┘
```

### 7.2 Storage Technology Mapping

| Data Category | Technology | Rationale |
|---------------|------------|-----------|
| **Ephemeral/Request** | Ray Object Store (Plasma) | Zero-copy sharing, automatic cleanup, distributed |
| **Session State** | PostgreSQL + JSONB | ACID transactions, flexible schema for checkpoints |
| **Persistent/Structured** | PostgreSQL (Row-based) | Strong consistency, relational queries |
| **Time-Series/Audit** | PostgreSQL + BRIN or TimescaleDB | Efficient time-range queries, partitioning |
| **File Content** | FileTracker (Content-addressed) | Deduplication, immutable blobs |

### 7.3 Indexing Strategy Summary

```
┌────────────────────────────────────────────────────────────────────────────────────┐
│                    INDEXING DECISION MATRIX                                         │
├────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                    │
│  INDEX TYPE │ USE WHEN                              │ EXAMPLE COLUMNS              │
│  ───────────┼───────────────────────────────────────┼──────────────────────────────│
│  B-Tree     │ Point lookups, range scans, ORDER BY  │ id, workflow_id, status      │
│  GIN        │ JSONB contains/exists queries         │ metrics, config              │
│  BRIN       │ Physically ordered data (time-series) │ created_at (append-only)     │
│  Hash       │ Equality-only lookups (rarely used)   │ N/A (B-Tree preferred)       │
│                                                                                    │
│  KEY INDEXES:                                                                      │
│  • wtb_executions(workflow_id, status) - Common filter pattern                    │
│  • checkpoints(internal_session_id, id) - Rollback chain traversal                │
│  • wtb_batch_test_results(batch_test_id) - Aggregate results                      │
│  • audit_events(created_at) BRIN - Time-range queries                             │
│                                                                                    │
└────────────────────────────────────────────────────────────────────────────────────┘
```

### 7.4 Transaction Boundaries

| Operation | Boundary | Consistency |
|-----------|----------|-------------|
| Create Execution | Single DB transaction | Strong |
| Node Checkpoint | Outbox pattern (WTB → AgentGit) | Eventual |
| Batch Test Aggregate | Collect from ObjectRefs | Eventual |
| Rollback | Single session transaction | Strong |
| File Commit | FileTracker transaction | Strong |

---

## 8. Ray-Based Batch Test Execution (2025-01)

### 8.1 Architecture Overview

```
┌────────────────────────────────────────────────────────────────────────────────────┐
│                    RAY BATCH TEST EXECUTION FLOW                                     │
├────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                    │
│  User Request                                                                      │
│      │                                                                             │
│      ▼                                                                             │
│  ┌──────────────────────────────────────────────────────────────────────────────┐ │
│  │  RayBatchTestRunner (Orchestrator)                                            │ │
│  │                                                                               │ │
│  │  1. Put workflow + initial_state → Ray Object Store                          │ │
│  │  2. Create Actor Pool (database connection reuse)                            │ │
│  │  3. Submit variants with backpressure control                                │ │
│  │  4. Collect results via ray.wait()                                           │ │
│  │  5. Build comparison matrix                                                   │ │
│  └───────────────────────────────────┬──────────────────────────────────────────┘ │
│                                      │                                             │
│          ┌───────────────────────────┼───────────────────────────┐                │
│          ▼                           ▼                           ▼                │
│  ┌───────────────────┐      ┌───────────────────┐      ┌───────────────────┐     │
│  │  Worker Node 1    │      │  Worker Node 2    │      │  Worker Node N    │     │
│  │                   │      │                   │      │                   │     │
│  │  @ray.remote(     │      │  @ray.remote(     │      │  @ray.remote(     │     │
│  │    num_cpus=1,    │      │    num_cpus=1,    │      │    num_cpus=1,    │     │
│  │    memory=2GB)    │      │    memory=2GB)    │      │    memory=2GB)    │     │
│  │                   │      │                   │      │                   │     │
│  │  • Apply variant  │      │  • Apply variant  │      │  • Apply variant  │     │
│  │  • Run workflow   │      │  • Run workflow   │      │  • Run workflow   │     │
│  │  • Save results   │      │  • Save results   │      │  • Save results   │     │
│  └───────────────────┘      └───────────────────┘      └───────────────────┘     │
│          │                           │                           │                │
│          └───────────────────────────┼───────────────────────────┘                │
│                                      ▼                                             │
│                          ┌───────────────────────┐                                │
│                          │  PostgreSQL (WTB DB)  │                                │
│                          │  • batch_tests        │                                │
│                          │  • batch_test_results │                                │
│                          │  • executions         │                                │
│                          └───────────────────────┘                                │
│                                                                                    │
└────────────────────────────────────────────────────────────────────────────────────┘
```

### 8.2 Key Design Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| **Execution Framework** | Ray | Distributed parallelism, resource management, fault tolerance |
| **Parallelism Unit** | Ray Actor | Database connection reuse, better than Tasks for stateful ops |
| **State Sharing** | ObjectRef (immutable) | Zero-copy, no race conditions |
| **Backpressure** | ray.wait() with limit | Prevents memory exhaustion |
| **Failure Handling** | max_retries + dead-letter | Automatic retry, explicit failure tracking |

### 8.3 Environment Management Integration

**Decision**: Adapt existing environment service via interface abstraction.

```
IEnvironmentProvider
├── InProcessProvider     (testing - no isolation)
├── RayEnvironmentProvider (production - Ray runtime_env)
└── GrpcEnvironmentProvider (optional - wraps existing service)
```

**Recommendation**: Use `RayEnvironmentProvider` by default. The existing gRPC environment manager can be integrated via `GrpcEnvironmentProvider` if container-level isolation is required.

### 8.4 Configuration Modes

```yaml
# Development (local Ray)
ray_enabled: true
ray_address: null  # Local mode
max_actors: 4

# Production (Ray cluster)
ray_enabled: true
ray_address: "ray://cluster-head:10001"
max_actors: 50
task_timeout: 7200
```

---

## 相关文档

| 文档                                        | 内容                             |
| ------------------------------------------- | -------------------------------- |
| `WORKFLOW_TEST_BENCH_ARCHITECTURE.md`     | 完整架构设计、Ray BatchTestRunner、领域模型、API 设计 |
| `DATABASE_DESIGN.md`                       | 三库架构、索引策略、存储决策 |
| `PROGRESS_TRACKER.md`                      | 实现状态跟踪 |
| [EventBus_and_Audit_Session/](../EventBus_and_Audit_Session/) | Event Bus 与审计设计 |
| [Adapter_and_WTB-Storage/](../Adapter_and_WTB-Storage/) | 状态适配器与存储设计 |
